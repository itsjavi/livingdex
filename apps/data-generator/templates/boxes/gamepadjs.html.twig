<script>
  document.addEventListener("DOMContentLoaded", function () {
    const reqAniFrame = window.mozRequestAnimationFrame || window.requestAnimationFrame;

    const focusableElements = document.querySelectorAll(
      '.box-cell[tabindex]:not([tabindex="-1"])'
    );

    console.log(focusableElements);

    let current = 0;

    function buttonPressed(b) {
      if (typeof (b) == "object") {
        return b.pressed;
      }
      return b === 1.0;
    }

    function calcNextBoxIndex() {
      return 30 * (Math.ceil(current/30) + 1) - 29;
    }

    function updateLoop() {
      const gamepad = navigator.getGamepads()[1];
      const gamepadActionB = gamepad.buttons[0]
      const gamepadActionA = gamepad.buttons[1]
      const gamepadActionY = gamepad.buttons[2]
      const gamepadActionX = gamepad.buttons[3]
      const gamepadBumperL = gamepad.buttons[4]
      const gamepadBumperR = gamepad.buttons[5]
      const gamepadBumperLZ = gamepad.buttons[6]
      const gamepadBumperRZ = gamepad.buttons[7]
      const gamepadMin = gamepad.buttons[8]
      const gamepadPlus = gamepad.buttons[9]
      const gamepadJoysticBtnL = gamepad.buttons[10]
      const gamepadJoysticBtnR = gamepad.buttons[11]
      const gamepadHome = gamepad.buttons[16]
      const gamepadScreenshot = gamepad.buttons[17]

      let t = 100;

      if (gamepadBumperL.pressed) {
        prevItem(30)
        t = 1000
      }
      if (gamepadBumperR.pressed) {
        nextItem(30)
        t = 1000
      }
      if(gamepad.axes[1] < -0.5) {
        prevItem(3)
      }
      if(gamepad.axes[1] > 0.5) {
        nextItem(3)
      }
      if(gamepad.axes[0] < -0.5) {
        prevItem(1)
      }
      if(gamepad.axes[0] > 0.5) {
        nextItem(1)
      }

      if (gamepadActionA.pressed) {
        focusableElements[current].focus()
      }

      if (gamepadActionB.pressed) {
        focusableElements[current].blur()
      }

      setTimeout(() => reqAniFrame(updateLoop), t)
    }

    function prevItem(offset) {
      current = Math.max(current - offset, 0);
      focusableElements[current].focus()
    }

    function nextItem(offset) {
      current = Math.min(current + offset, focusableElements.length);
      if (current === focusableElements.length) {
        current = 0;
      }
      focusableElements[current].focus()
    }

    function clickItem(index) {
      focusableElements[index].click();
    }

    window.addEventListener("gamepadconnected", function (e) {
      let gamepadInfo = document.getElementById("gamepadInfo");
      let gp = navigator.getGamepads()[e.gamepad.index];
      gamepadInfo.innerHTML = "Gamepad connected at index " + gp.index + ": " + gp.id + ". It has " + gp.buttons.length + " buttons and " + gp.axes.length + " axes.";

      updateLoop();
    });
  });
</script>
